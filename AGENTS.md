# Repository Guidelines

## Project Structure & Module Organization
- `main.go` starts the service and defers to the Cobra CLI in `cmd/`.
- Request handlers sit under `handlers/`, with cross-cutting middleware in `middlewares/securityheaders` and `middlewares/session`.
- Core auth logic lives in domain packages such as `user/`, `loginlimit/`, `totp/`, `rules/`, and supporting helpers under `util/`.
- Persistence code targets SQLite via `db/sqlite/`, configuration types live in `config/`, and onboarding flows are grouped in `ftue/`.
- UI templates and static assets reside in `render/templates` and `render/static`, while mocks generated by Mockery are stored in `mocks/`.

## Build, Test, and Development Commands
- `go run .` launches the server locally on port 9000 for manual testing.
- `go build ./...` ensures every package compiles and matches CI's compile step.
- `go test ./...` runs the full suite; `gotestsum --format github-actions` replicates CI output formatting.
- `go install gotest.tools/gotestsum@latest` installs the test runner required by the workflow.
- `make docker` builds the local image; `make mulitdocker` executes a multi-architecture `docker buildx` build.

## Coding Style & Naming Conventions
- Target Go 1.25, rely on `gofmt` (tabs, canonical import ordering), and keep files in `snake_case.go`.
- Exported APIs use PascalCase, internal helpers stay lowerCamelCase, and HTTP handlers should follow the `<Feature>Handler` pattern.
- Prefer structured logging via `zerolog`; avoid bare `fmt.Println` in non-test code.
- Regenerate doubles with `mockery --config .mockery.yml` whenever interface contracts change.

## Testing Guidelines
- Write package-local `_test.go` files using Go's `testing` plus `stretchr/testify` assertions where helpful.
- Favor table-driven tests with descriptive `t.Run("scenario", ...)` names to clarify intent.
- Use mocks from `mocks/` to isolate external dependencies, especially for auth, rules, or database flows.
- Run `go test ./...` (or `gotestsum`) before pushing and expand coverage when introducing new behavior or bug fixes.

## Commit & Pull Request Guidelines
- Keep commit subjects short, present-tense imperatives (e.g., `add passkey validation`) and mirror history patterns like `Minor bugfixes (#19)` when referencing issues.
- Document changes clearly in PR descriptions, including manual test evidence (`go test ./...`, `gosec ./...`) and screenshots for UI updates.
- Ensure CI parity by running the same commands locally, and avoid committing generated artifacts such as `main.db`.
- Call out required configuration changes or migration steps so reviewers can validate updates quickly.

## Security & Configuration Tips
- Store runtime configuration outside the repo; the service expects `/config` to contain secrets and the SQLite database.
- Use `example/config` as a sanitized template and never commit real credentials, tokens, or user data.
- Execute `gosec ./...` when touching security-sensitive code paths and surface notable findings in PRs.
- Update `README.md` when introducing new environment variables, Traefik rules, or deployment considerations.
